name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  quality-gate:
    name: Build & Lint Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    # 1. Frontend Checks
    - name: Lint Frontend
      run: npm run lint -w frontend
      
    - name: Typecheck & Build Frontend
      run: npm run build -w frontend

    # 2. Backend Checks
    - name: Typecheck Backend
      run: npm run build -w backend

    # 3. Workers Checks
    - name: Typecheck Workers
      run: npm run build -w workers

  # Example of a CD Job (Deploy)
  # This would run only on main branch after quality-gate passes
  deploy-backend:
    name: Deploy Backend (Docker)
    needs: quality-gate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker Image
        run: docker build -f backend/Dockerfile -t resume-backend .
      # - name: Push to ECR/DockerHub
      #   run: ...
      # - name: Deploy to ECS/EC2
      #   run: ...

  deploy-frontend:
    name: Deploy Frontend (S3)
    needs: quality-gate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install & Build
        run: |
          npm ci
          npm run build -w frontend
      # - name: Sync to S3
      #   run: aws s3 sync ./frontend/dist s3://${{ secrets.AWS_BUCKET_NAME }}
      # - name: Invalidate CloudFront
      #   run: aws cloudfront create-invalidation ...
